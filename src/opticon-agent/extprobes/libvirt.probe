#!/bin/bash
cat << _EOF_
{
    "vm":[
_EOF_

mkdir -p /var/run/opticon/libvirt.probe
virsh list | grep running | sed -e 's/^ [0-9]* *//;s/ *running//g' | while read vmname; do
  ramkb=$(virsh dominfo "$vmname" | grep '^Used memory' | sed -e 's/.*: *//;s/ .*//')
  numcpu=$(virsh dominfo "$vmname" | grep '^Used memory' | sed -e 's/.*: *//;s/ .*//')
  ram=$((ramkb / 1024))
  cachefile="/var/run/opticon/libvirt.probe/${vmname}.vm"
  [ -e "$cachefile" ] && . "$cachefile"
  nw_date=$(date +%s)
  nw_cputime=$(virsh cpu-stats --total "$vmname" | grep cpu_time | sed -e 's/.*cpu_time *//' | cut -f1 -d.)
  if [ -z "$last_date" ]; then
    echo "        { name:\"$vmname\", cores:$numcpu, ram:$ram, cpu:0.0 }"
  else
    tdiff=$((nw_date - last_date))
    [ $tdiff -lt 1 ] && tdiff=1
    cpudiff=$((nw_cputime - last_cputime))
    cpuperc=$((cpudiff / tdiff))
    echo "        { name:\"$vmname\", cores:$numcpu, ram:$ram, cpu:${cpuperc}.0 }"
  fi
  
  printf 'last_date="%s"\n' "$nw_date" > $cachefile
  printf 'last_cputime="%s"\n' "$nw_cputime" >> $cachefile
done
cat << _EOF_
    ]
}
_EOF_
